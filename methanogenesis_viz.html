<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  
  <title>Pathwiz - Methanogenesis</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --primary-color: #4a90e2;
      --primary-hover: #357abd;
      --bg-color: #f0f2f5;
      --sidebar-bg: #ffffff;
      --sidebar-width: 380px;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
      height: 100vh;
      width: 100vw;
      display: flex;
      overflow: hidden;
      background-color: var(--bg-color);
    }

    /* --- 布局容器 --- */
    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      flex-direction: row;
    }

    /* 左侧控制栏 */
    .sidebar {
      width: var(--sidebar-width);
      min-width: 300px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid #e1e4e8;
      padding: 30px 25px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      box-shadow: 4px 0 15px rgba(0,0,0,0.02);
      z-index: 20;
      overflow-y: auto;
    }

    /* 右侧主视图 */
    .main-content {
      flex: 1;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background-color: var(--bg-color);
      overflow: hidden;
    }

    /* --- UI 组件样式 --- */
    h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
      color: #1E293A;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .description {
      font-size: 14px;
      color: #7f8c8d;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    label {
      font-size: 12px;
      font-weight: 700;
      color: #95a5a6;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    textarea, input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 15px;
      border: 2px solid #ecf0f1;
      border-radius: 10px;
      font-family: 'Fira Code', 'Consolas', monospace;
      font-size: 14px;
      color: #1E293A;
      background: #fdfdfd;
      transition: all 0.3s ease;
      outline: none;
    }

    textarea {
      resize: vertical;
      min-height: 120px;
    }

    input[type="text"] {
      padding: 12px;
      font-family: "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
    }

    textarea:focus, input[type="text"]:focus {
      border-color: var(--primary-color);
      background: #fff;
      box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.1);
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }

    button {
      padding: 14px 20px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 4px 6px rgba(74, 144, 226, 0.25);
    }
    .btn-primary:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(74, 144, 226, 0.35);
    }
    .btn-primary:active { transform: translateY(0); }

    .btn-secondary {
      background-color: white;
      border: 2px solid #ecf0f1;
      color: #7f8c8d;
    }
    .btn-secondary:hover {
      border-color: #bdc3c7;
      color: #1E293A;
      background-color: #fbfbfb;
    }

    /* Export Buttons Row */
    .btn-row {
      display: flex;
      gap: 10px;
    }
    .btn-export {
      flex: 1;
      background-color: #1E293A;
      color: #fff;
      font-size: 13px;
      padding: 10px;
    }
    .btn-export:hover {
      background-color: #1E293A;
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    .footer-controls {
      margin-top: auto; 
      padding-top: 20px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .btn-text {
      background: none;
      border: none;
      color: #bdc3c7;
      font-size: 12px;
      font-weight: 400;
      padding: 5px;
    }
    .btn-text:hover {
      color: #7f8c8d;
      text-decoration: underline;
    }

    /* --- Button Icons --- */
    .btn-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      margin-right: 6px;
      flex-shrink: 0;
    }

    /* --- SVG Adapter --- */
    #svg {
      width: auto;
      height: auto;
      max-width: 98%;
      max-height: 98%;
      display: block;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    /* --- 响应式适配 --- */
    @media (max-width: 900px) {
      .app-container { flex-direction: column; }
      .sidebar {
        width: 100%; max-height: 45vh;
        border-right: none; border-bottom: 1px solid #e1e4e8;
        padding: 20px;
        box-sizing: border-box;
      }
      textarea { min-height: 80px; }
      .main-content { height: 55vh; }
    }

    /* --- D3 Styles --- */
    .highlight rect, .highlight circle, .highlight path, .highlight line {
      stroke: #e74c3c !important;
      stroke-width: 4 !important;
      filter: drop-shadow(0 0 4px rgba(231, 76, 60, 0.6));
    }
    .st35 { fill: #ffe8c0; }
    .st34 { fill: #cecece; }
    .st39 { fill: #fbcccd; }
    .st40 { fill: #dad7ec; }
    .st38 { fill: #c9e5c7; }
    .enzyme rect { rx: 6; ry: 6; stroke: #444; stroke-width: 1; cursor: default; }
    .label { fill: #222; font-size: 14px; font-family: Arial, sans-serif; }
    .big-label { fill: #000; font-size: 18px; font-weight: 700; }
    .small-label { fill: #555; font-size: 11px; }
    .pill { rx: 16; ry: 16; stroke: none; opacity: 0.9; }

    /* --- Toggle Switch --- */
    .switch-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-top: 1px solid #f0f0f0;
      margin-top: 15px;
    }
    .switch-label {
      font-size: 14px;
      color: #1E293A;
      font-weight: 600;
    }
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #cbd5e1;
      transition: .3s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    /* --- Grayscale Mode --- */
    #svg.grayscale-active { background-color: #fafafa; }
    #svg.grayscale-active > g > g:not(.highlight),
    #svg.grayscale-active > g > path,
    #svg.grayscale-active > g > line,
    #svg.grayscale-active > g > circle,
    #svg.grayscale-active > g > text {
      filter: grayscale(100%);
      transition: all 0.4s ease;
    }
    #svg.grayscale-active > g > g.highlight {
      filter: none;
      transition: all 0.4s ease;
    }
  </style>
</head>
<body>

<div class="app-container">
  
  <!-- 左侧边栏 -->
  <div class="sidebar">
    <div>
      <h2>Pathwiz</h2>
      <p class="description">Methanogenesis pathway from CO2, Acetate, and Methyl-compounds.</p>
    </div>

    <div class="input-group">
      <label for="titleInput">Figure Title</label>
      <input type="text" id="titleInput" placeholder="(Optional)" oninput="updateTitle()">
    </div>

    <div class="input-group">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <label for="kwInput">Keywords / Identifiers</label>
        <button class="btn-text" onclick="fillExample()" style="font-size: 11px; padding: 0; color: var(--primary-color);">Fill Example</button>
      </div>
      <textarea id="kwInput" placeholder="e.g. K00201, Mtt, McrA...&#10;IDs joined by commas or new lines..."></textarea>
    </div>

    <div class="button-group">
      <button class="btn-primary" onclick="highlight()">
        <span class="btn-icon"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l-6 6v3h9l3-3" /><path d="M22 12l-4.6 4.6a2 2 0 01-2.8 0l-5.2-5.2a2 2 0 010-2.8L14 4" /></svg></span>
        Highlight Pathway
      </button>
      <button class="btn-secondary" onclick="clearHighlight()">
        <span class="btn-icon"><svg viewBox="0 0 24 24" fill="#7f8c8d"><path d="M13.9907,1.31133017e-07 C14.8816,1.31133017e-07 15.3277,1.07714 14.6978,1.70711 L13.8556,2.54922 C14.421,3.15654 14.8904,3.85028 15.2448,4.60695 C15.8028,5.79836 16.0583,7.109 15.9888,8.42277 C15.9193,9.73654 15.5268,11.0129 14.8462,12.1388 C14.1656,13.2646 13.2178,14.2053 12.0868,14.8773 C10.9558,15.5494 9.67655,15.9322 8.3623,15.9918 C7.04804,16.0514 5.73937,15.7859 4.55221,15.2189 C3.36505,14.652 2.33604,13.8009 1.55634,12.7413 C0.776635,11.6816 0.270299,10.446 0.0821822,9.14392 C0.00321229,8.59731 0.382309,8.09018 0.928918,8.01121 C1.47553,7.93224 1.98266,8.31133 2.06163,8.85794 C2.20272,9.83451 2.58247,10.7612 3.16725,11.556 C3.75203,12.3507 4.52378,12.989 5.41415,13.4142 C6.30452,13.8394 7.28602,14.0385 8.27172,13.9939 C9.25741,13.9492 10.2169,13.6621 11.0651,13.158 C11.9133,12.6539 12.6242,11.9485 13.1346,11.1041 C13.6451,10.2597 13.9395,9.30241 13.9916,8.31708 C14.0437,7.33175 13.8521,6.34877 13.4336,5.45521 C13.178,4.90949 12.8426,4.40741 12.4402,3.96464 L11.7071,4.69779 C11.0771,5.32776 9.99996,4.88159 9.99996,3.99069 L9.99996,1.31133017e-07 L13.9907,1.31133017e-07 Z M1.499979,4 C2.05226,4 2.499979,4.44772 2.499979,5 C2.499979,5.55229 2.05226,6 1.499979,6 C0.947694,6 0.499979,5.55228 0.499979,5 C0.499979,4.44772 0.947694,4 1.499979,4 Z M3.74998,1.25 C4.30226,1.25 4.74998,1.69772 4.74998,2.25 C4.74998,2.80229 4.30226,3.25 3.74998,3.25 C3.19769,3.25 2.74998,2.80228 2.74998,2.25 C2.74998,1.69772 3.19769,1.25 3.74998,1.25 Z M6.99998,0 C7.55226,0 7.99998,0.447716 7.99998,1 C7.99998,1.55229 7.55226,2 6.99998,2 C6.44769,2 5.99998,1.55229 5.99998,1 C5.99998,0.447716 6.44769,0 6.99998,0 Z"></path></svg></span>
        Clear Selection
      </button>
    </div>

    <div class="switch-container">
      <span class="switch-label">Grayscale Mode</span>
      <label class="switch">
        <input type="checkbox" id="grayscaleToggle" onchange="toggleGrayscale()">
        <span class="slider"></span>
      </label>
    </div>

    <!-- 导出按钮区域 -->
    <div class="input-group" style="margin-top: 10px;">
      <label>Export Figure</label>
      <div class="btn-row">
        <button class="btn-export" onclick="saveSvg()">
          <span class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-code" aria-hidden="true"><path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"></path><path d="M14 2v5a1 1 0 0 0 1 1h5"></path><path d="M10 12.5 8 15l2 2.5"></path><path d="m14 12.5 2 2.5-2 2.5"></path></svg></span>
          Save SVG
        </button>
        <button class="btn-export" onclick="saveJpg()">
          <span class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-image" aria-hidden="true"><path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z"></path><path d="M14 2v5a1 1 0 0 0 1 1h5"></path><circle cx="10" cy="12" r="2"></circle><path d="m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22"></path></svg></span>
          Save JPG
        </button>
      </div>
    </div>

    <div class="footer-controls">
       <div style="font-size: 12px; color:#aaa; margin-bottom:5px;">
         Shortcut: <strong>Ctrl + Enter</strong> to highlight
       </div>
       <button class="btn-text" onclick="toggleDebug()">
         <span class="btn-icon" style="width: 14px; height: 14px; margin-right: 4px;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bug" aria-hidden="true"><path d="M12 20v-9"></path><path d="M14 7a4 4 0 0 1 4 4v3a6 6 0 0 1-12 0v-3a4 4 0 0 1 4-4z"></path><path d="M14.12 3.88 16 2"></path><path d="M21 21a4 4 0 0 0-3.81-4"></path><path d="M21 5a4 4 0 0 1-3.55 3.97"></path><path d="M22 13h-4"></path><path d="M3 21a4 4 0 0 1 3.81-4"></path><path d="M3 5a4 4 0 0 0 3.55 3.97"></path><path d="M6 13H2"></path><path d="m8 2 1.88 1.88"></path><path d="M9 7.13V6a3 3 0 1 1 6 0v1.13"></path></svg></span>
         Toggle SVG Debug Grid
       </button>
       <a href="https://github.com/SilentGene/pathwiz" target="_blank" class="btn-text" style="display: inline-flex; align-items: center; text-decoration: none; margin-top: 5px;">
         <span class="btn-icon" style="width: 16px; height: 16px; margin-right: 6px;">
           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
             <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
           </svg>
         </span>
         &copy; 2025 Heyu Lin
       </a>

    </div>
  </div>

  <!-- 右侧图表区 -->
  <div class="main-content">
    <svg id="svg" viewBox="0 0 640.67 589.39" preserveAspectRatio="xMidYMid meet"></svg>
  </div>

</div>

<script>
// SVG init
const svg = d3.select("#svg");

// Data Definition
const methanogenesisData = {
  "Fwd": { label: "Fwd", kw: ["K00202", "K00200", "K00201", "K00203", "K00204", "K00205", "K11261", "K11260", "FwdA"] },
  "Ftr": { label: "Ftr", kw: ["K00672", "Ftr"] },
  "Mch": { label: "Mch", kw: ["K01499", "Mch"] },
  "Mtd_Hmd": { label: "Mtd/Hmd", kw: ["K13942", "K00319", "K00300", "K10714", "MtdA", "HmdA"] },
  "Mer": { label: "Mer", kw: ["K00320", "Mer"] },
  "Mtr": { label: "Mtr", kw: ["K00580", "K00579", "K00578", "K00577", "K00582", "K00583", "K00584", "MtrA"] },
  "Mcr": { label: "Mcr", kw: ["K00401", "K00402", "K03421", "K03422", "K00399", "McrA"] },
  "Ech": { label: "Ech", kw: ["K14086", "K14087", "K14088", "K14089", "K14090", "K14091"] },
  "Fpo1": { label: "Fpo", kw: ["K22158", "K22159", "K22160", "K22161", "K22162", "K22163", "K22164", "K22165", "K22166", "K22167", "K22168", "K22169", "K22170"] },
  "Fpo2": { label: "Fpo", kw: ["K22158", "K22159", "K22160", "K22161", "K22162", "K22163", "K22164", "K22165", "K22166", "K22167", "K22168", "K22169", "K22170"] },
  "MvhADG_HdrABC": { label: "MvhADG-\nHdrABC", kw: ["K14126", "K14127", "K14128", "K22480", "K22481", "K22482", "K03388", "K03389", "K03390"] },
  "CdhAB_CooSF": { label: "CdhAB\nCooSF", kw: ["K00192", "K00195", "K00196", "K00198", "CdhA", "CdhB", "CooS", "CooF"] },
  "Fdh_Fdo_Fdw": { label: "Fdh/Fdo/Fdw", kw: ["K05299", "K15022", "K22516", "K00125", "K22515", "K00123", "K00124"] },
  "Ack": { label: "Ack", kw: ["K00925", "Ack"] },
  "Pta": { label: "Pta", kw: ["K00625", "Pta"] },
  "CdhCDE": { label: "CdhCDE\n(ACDS)", kw: ["K00194", "K00193", "K00197", "CdhC", "CdhD", "CdhE"] },
  "Acs": { label: "Acs", kw: ["K15023", "K14138"] },
  "Mta": { label: "Mta", kw: ["K14080", "K04480", "K14081", "MtaA", "MtaB", "MtaC"] },
  "MtmBC": { label: "MtmBC", kw: ["K16176", "K16177", "MtmB", "MtmC"] },
  "MtbBC": { label: "MtbBC", kw: ["K16178", "K16179", "MtbB", "MtbC"] },
  "MttBC": { label: "MttBC", kw: ["K14083", "K14084", "MttB", "MttC"] },
  "MtbA": { label: "MtbA", kw: ["K14082", "MtbA"] }
};

// Title element (initially empty)
const titleNode = svg.append("text")
  .attr("id", "svg-title")
  .attr("x", 10) // Left aligned
  .attr("y", 30)
  .attr("text-anchor", "start")
  .attr("font-family", "Segoe UI, Roboto, Oxygen-Sans, Ubuntu, Cantarell, Helvetica Neue, sans-serif")
  .attr("font-size", "22px")
  .attr("font-weight", "700")
  .attr("fill", "#1E293A")
  .text("");

const g = svg.append("g");

// Arrows
const markerColors = ["#f8991d", "#ef3d39", "#2ab34b", "#6f8ac6", "#555"];
const defs = svg.append("defs");
markerColors.forEach(color => {
  const id = `arrow-${color.substring(1)}`;
  const m = defs.append("marker")
    .attr("id", id)
    .attr("viewBox", "0 0 10 10")
    .attr("refX", 8)
    .attr("refY", 5)
    .attr("markerWidth", 5)
    .attr("markerHeight", 5)
    .attr("orient", "auto-start-reverse");
  m.append("path").attr("d", "M 0 0 L 10 5 L 0 10 z").attr("fill", color);
});

// Drawing Helpers
function drawBox(props) {
  let {id, x, y, w, h, label, cls, kw=[], enzyme=true} = props;

  // Merge with external data if available
  if (typeof methanogenesisData !== 'undefined' && methanogenesisData[id]) {
    const data = methanogenesisData[id];
    if (data.label) label = data.label;
    if (data.kw) kw = data.kw;
  }

  const classes = [cls||''];
  if (enzyme) classes.push('enzyme');
  const ng = g.append("g").attr("class", classes.join(' ').trim()).attr("id", id);
  ng.append("rect").attr("x", x).attr("y", y).attr("width", w).attr("height", h);
  const lines = String(label || id).split(/\n/);
  const lineHeight = 14;
  const txt = ng.append("text")
    .attr("text-anchor", "middle")
    .attr("class", "label")
    .attr("x", x + w/2)
    .attr("y", y + h/2)
    .attr("dominant-baseline", "middle");
  lines.forEach((ln, i) => {
    const t = txt.append("tspan").text(ln).attr("x", x + w/2);
    if (i === 0) t.attr("dy", `${-((lines.length - 1) / 2) * lineHeight}`);
    else t.attr("dy", `${lineHeight}`);
  });
  const tooltip = [label || id, kw.length ? ` [${kw.join(', ')}]` : ''].join('');
  ng.append('title').text(tooltip);
  ng.attr("data-kw", kw.join(","));
}

function drawText({x,y,text,cls="label"}) {
  const lines = String(text).split(/\n/);
  const el = g.append("text").attr("x", x).attr("y", y).attr("class", cls);
  
  let lineHeight = 14;
  if (cls && /big-label/.test(cls)) lineHeight = 18;
  else if (cls && /small-label/.test(cls)) lineHeight = 12;
  
  el.attr("dominant-baseline", "middle");
  
  lines.forEach((ln, i) => {
    const t = el.append("tspan").attr("x", x);
    if (i === 0) t.attr("dy", `${-((lines.length - 1) / 2) * lineHeight}`);
    else t.attr("dy", `${lineHeight}`);
    
    const parts = ln.split(/(<sub>.*?<\/sub>)/g);
    parts.forEach(part => {
      if (part.startsWith("<sub>") && part.endsWith("</sub>")) {
        t.append("tspan")
         .attr("baseline-shift", "sub")
         .attr("font-size", "0.7em")
         .text(part.replace(/<\/?sub>/g, ""));
      } else if (part) {
        t.append("tspan").text(part);
      }
    });
  });
  return el;
}

function drawLine({x1,y1,x2,y2,color,width=2,arrow=true}) {
  const ln = g.append("line")
    .attr("x1", x1).attr("y1", y1).attr("x2", x2).attr("y2", y2)
    .attr("stroke", color).attr("stroke-width", width);
  if (arrow) ln.attr("marker-end", `url(#arrow-${color.substring(1)})`);
}

function drawRing({cx, cy, r=4.58, color="#f8991d", width=2}) {
  g.append("circle")
    .attr("cx", cx).attr("cy", cy).attr("r", r)
    .attr("fill", "#ffffff").attr("stroke", color).attr("stroke-width", width);
}

function drawPath({d, color, width=2, arrow=true}) {
  const p = g.append("path")
    .attr("d", d)
    .attr("fill", "none")
    .attr("stroke", color)
    .attr("stroke-width", width);
  if (arrow) p.attr("marker-end", `url(#arrow-${color.substring(1)})`);
}

function drawPill({x, y, w, h, label, cls}) {
  const classes = ["pill", cls || ""].join(" ").trim();
  const ng = g.append("g");
  ng.append("rect")
    .attr("x", x).attr("y", y)
    .attr("width", w).attr("height", h)
    .attr("class", classes)
    .attr("rx", 15).attr("ry", 15);
  ng.append("text")
    .attr("x", x + w/2)
    .attr("y", y + h/2)
    .attr("text-anchor", "middle")
    .attr("dominant-baseline", "middle")
    .attr("class", "label")
    .text(label);
  return ng;
}

// Drawing
drawPill({x:298, y:43, w:129, h:32, label:"Hydrogenotrophic", cls:"st35"});
drawPill({x:124, y:189, w:100, h:32, label:"Acetoclastic", cls:"st39"});
drawPill({x:70, y:423, w:110, h:32, label:"Methylotrophic", cls:"st40"});

drawText({x:345.36, y:92, text:"CO<sub>2</sub>", cls:"big-label"});
drawText({x:219, y:110, text:"CO", cls:"big-label"});
drawText({x:510, y:110, text:"formate", cls:"big-label"});
drawText({x:370, y:169.21, text:"formyl-MF"});
drawText({x:370, y:217, text:"formyl-H<sub>4</sub>SPt"});
drawText({x:370, y:266, text:"methenyl-H<sub>4</sub>SPt"});
drawText({x:370, y:316, text:"methylene-H<sub>4</sub>SPt"});
drawText({x:370, y:365, text:"methyl-H<sub>4</sub>SPt"});
drawText({x:370, y:419, text:"methyl-CoM"});
drawText({x:342.07, y:550, text:"CH<sub>4</sub>", cls:"big-label"});
drawText({x:419, y:452, text:"CoB-SH\nCoM-SH"});
drawText({x:407, y:515, text:"CoM-S-S-CoB"});
drawText({x:405, y:133, text:"Fd<sub>red2-</sub>", cls:"small-label"});
drawText({x:397, y:152, text:"Fd<sub>dox</sub>", cls:"small-label"});
drawText({x:423, y:280, text:"F420H<sub>2</sub>", cls:"small-label"});
drawText({x:408, y:300, text:"F420+2H<sub>2</sub>", cls:"small-label"});
drawText({x:406, y:333, text:"F420H<sub>2</sub>", cls:"small-label"});
drawText({x:399, y:349, text:"F420+2H<sub>2</sub>", cls:"small-label"});

const orange = "#f8991d";
drawLine({x1:360,y1:110,x2:360,y2:520,color:orange});
drawLine({x1:382,y1:450,x2:414,y2:450,color:orange, arrow:false});
drawLine({x1:382,y1:450,x2:382,y2:510,color:orange, arrow:false});
drawLine({x1:382,y1:510,x2:400,y2:510,color:orange});
drawLine({x1:528,y1:450,x2:476,y2:450,color:orange});
drawLine({x1:528,y1:450,x2:528,y2:510,color:orange, arrow:false});
drawLine({x1:528,y1:510,x2:498,y2:510,color:orange, arrow:false});
[108, 162, 210, 262, 310, 358, 415, 528].forEach(y => drawRing({cx:360, cy:y, color:orange}));

drawBox({id:"Fwd", x:339.51, y:126.78, w:40.04, h:22.49, cls:"st35", enzyme:true});
drawBox({id:"Ftr", x:339.33, y:174.78, w:40.04, h:22.49, cls:"st35", enzyme:true});
drawBox({id:"Mch", x:336.58, y:226.33, w:42.78, h:22.49, cls:"st35", enzyme:true});
drawBox({id:"Mtd_Hmd", x:326.53, y:274.6, w:68.56, h:22.49, cls:"st35", enzyme:true});
drawBox({id:"Mer", x:339.33, y:323.96, w:40.04, h:22.49, cls:"st35", enzyme:true});
drawBox({id:"Mtr", x:339.33, y:372.78, w:40.04, h:22.49, cls:"st35", enzyme:true});
drawBox({id:"Mcr", x:339.15, y:459.99, w:40.04, h:22.49, cls:"st35", enzyme:true});

drawBox({id:"Ech", x:460.36, y:130.9,  w:28.32, h:15.91, cls:"st34", enzyme:true});
drawBox({id:"Fpo1",x:486.14, y:278.44, w:28.32, h:15.91, cls:"st34", enzyme:true});
drawBox({id:"Fpo2",x:469.68, y:327.8,  w:28.32, h:15.91, cls:"st34", enzyme:true});
drawBox({id:"MvhADG_HdrABC", x:488.33, y:459.99, w:71.3, h:32, cls:"st35", enzyme:true});

drawLine({x1:254, y1:109, x2:354, y2:109, color:"#ef3d39"});
drawLine({x1:496, y1:109, x2:367, y2:109, color:"#2ab34b"});
drawBox({id:"CdhAB_CooSF", x:279.1, y:90, w:53.2, h:36.75, cls:"st39", enzyme:true});
drawBox({id:"Fdh_Fdo_Fdw", x:388.32, y:98, w:101.47, h:22.49, cls:"st38", enzyme:true});
drawRing({cx:255, cy:109, color:"#ef3d39"});
drawRing({cx:501, cy:109, color:"#2ab34b"});

const red = "#ef3d39";
drawLine({x1:188,y1:251,x2:188,y2:349,color:red});
drawLine({x1:192, y1:358, x2:355, y2:358, color:red});
drawPath({ d: "M192,247c27.18,2.9,48.35,25.9,48.35,53.85,0,23.94-15.54,44.26-46,55", color: red, width: 2, arrow: true });
[247, 298, 357].forEach(y => drawRing({cx:188, cy:y, color:red}));
drawBox({id:"Ack", x:168.57, y:265.05, w:40.04, h:22.49, cls:"st39", enzyme:true});
drawBox({id:"Pta", x:168.85, y:309.48, w:40.04, h:22.49, cls:"st39", enzyme:true});
drawBox({id:"CdhCDE", x:235.48, y:348.64, w:66.37, h:33.46, cls:"st39", enzyme:true});
drawBox({id:"Acs", x:219, y:290, w:40.04, h:22.49, cls:"st39", enzyme:true});
drawText({x:130, y:249, text:"acetate"});
drawText({x:122, y:304, text:"acetyl-Pi"});
drawText({x:110, y:363, text:"acetyl-CoA"});

const blue = "#6f8ac6";
[482, 510, 538, 566].forEach(y => drawRing({cx:143, cy:y, color:blue}));
drawLine({x1:147, y1:482, x2:300, y2:482, color:blue, arrow:false});
drawLine({x1:147, y1:510, x2:240, y2:510, color:blue, arrow:false});
drawLine({x1:147, y1:538, x2:300, y2:538, color:blue, arrow:false});
drawLine({x1:147, y1:566, x2:240, y2:566, color:blue, arrow:false});
drawLine({x1:240, y1:510, x2:240, y2:566, color:blue, arrow:false});
drawLine({x1:300, y1:538, x2:300, y2:415, color:blue, arrow:false});
drawLine({x1:300, y1:415, x2:354, y2:415, color:blue});
drawBox({id:"Mta",   x:162.41, y:470.96, w:40.04, h:22.49, cls:"st40", enzyme:true});
drawBox({id:"MtmBC", x:162.41, y:497.83, w:59.59, h:22.49, cls:"st40", enzyme:true});
drawBox({id:"MtbBC", x:162.41, y:525.26, w:59.59, h:22.49, cls:"st40", enzyme:true});
drawBox({id:"MttBC", x:162.41, y:552.68, w:58.59, h:22.49, cls:"st40", enzyme:true});
drawBox({id:"MtbA",  x:250,  y:525.26, w:40.57, h:22.49, cls:"st40", enzyme:true});
drawText({x:70, y:485, text:"methanol"});
drawText({x:50, y:513, text:"methylamine"});
drawText({x:40, y:541, text:"dimethylamine"});
drawText({x:35,  y:569,  text:"trimethylamine"});

// Three orange curved paths (left)
drawPath({ d: "M405.81,293.51c-6.1-1.64-10.17-4.58-10.17-7.94,0-5.15,9.58-9.32,21.39-9.32", color: orange });
drawPath({ d: "M390.46,147.06c-6.1-1.64-10.17-4.58-10.17-7.94,0-5.15,9.58-9.32,21.39-9.32", color: orange });
drawPath({ d: "M389.91,343.97c-6.1-1.64-10.17-4.58-10.17-7.94,0-5.15,9.58-9.32,21.39-9.32", color: orange });
// Three orange curved paths (right)
drawPath({ d: "M446.9,131.18c6.1,1.64,10.17,4.58,10.17,7.94,0,5.15-9.58,9.32-21.39,9.32", color: orange });
drawPath({ d: "M457.32,329.19c6.1,1.64,10.17,4.58,10.17,7.94,0,5.15-9.58,9.32-21.39,9.32", color: orange });
drawPath({ d: "M472.68,279.27c6.1,1.64,10.17,4.58,10.17,7.94,0,5.15-9.58,9.32-21.39,9.32", color: orange });

// Logic
window.updateTitle = function() {
  const val = document.getElementById("titleInput").value;
  d3.select("#svg-title").text(val);
}

window.highlight = function() {
  const raw = document.getElementById("kwInput").value.toUpperCase();
  const tokens = raw.split(/[\s,;]+/).map(t => t.trim()).filter(Boolean);
  g.selectAll(".highlight").classed("highlight", false);
  if (!tokens.length) return;
  g.selectAll("g.enzyme").each(function() {
    const k = (this.getAttribute("data-kw")||"").toUpperCase().split(",").map(s=>s.trim()).filter(Boolean);
    const match = k.some(v => tokens.includes(v));
    if (match) d3.select(this).classed("highlight", true);
  });
}

window.clearHighlight = function() {
  g.selectAll(".highlight").classed("highlight", false);
  document.getElementById("kwInput").value = "";
}

window.fillExample = function() {
  // Example Keywords for testing
  const examples = ["K00200", "K00580", "K00401", "K03388", "McrA", "K00925", ];
  document.getElementById("kwInput").value = examples.join(", ");
}

window.toggleGrayscale = function() {
  const cb = document.getElementById("grayscaleToggle");
  d3.select("#svg").classed("grayscale-active", cb.checked);
}

function bindKwInputHotkey() {
  const inp = document.getElementById('kwInput');
  if (inp && !inp.dataset.bound) {
    inp.addEventListener('keydown', function(e){
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        window.highlight();
      }
    });
    inp.dataset.bound = '1';
  }
}
bindKwInputHotkey();

// --- Export Functions ---
function getSafeFilename(ext) {
  const base = "methanogenesis_pathway";
  const val = document.getElementById("titleInput").value.trim();
  if (!val) return base + "." + ext;
  const safe = val.replace(/[\\/:*?"<>|]/g, "_");
  return base + "-" + safe + "." + ext;
}

function getSvgData() {
  const svgEl = document.getElementById("svg");
  const serializer = new XMLSerializer();
  let source = serializer.serializeToString(svgEl);
  
  const styles = Array.from(document.querySelectorAll("style"))
                      .map(s => s.innerText)
                      .join("\n");
  
  if(!source.match(/<style/)) {
      source = source.replace('>', `><style>${styles}</style>`);
  }
  return source;
}

window.saveSvg = function() {
  const source = getSvgData();
  const blob = new Blob([source], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  
  const link = document.createElement("a");
  link.href = url;
  link.download = getSafeFilename("svg");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

function saveJpg() {
  const source = getSvgData();
  const w = 640.67; 
  const h = 589.39; 
  
  // Use base64 encoding for better compatibility
  const base64 = btoa(unescape(encodeURIComponent(source)));
  const dataUrl = 'data:image/svg+xml;base64,' + base64;
  
  const img = new Image();
  let timeoutId;
  
  img.onload = function() {
    clearTimeout(timeoutId);
    try {
      const canvas = document.createElement("canvas");
      const scale = 2; 
      canvas.width = w * scale;
      canvas.height = h * scale;
      const ctx = canvas.getContext("2d");
      
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      ctx.scale(scale, scale);
      ctx.drawImage(img, 0, 0, w, h);
      
      const link = document.createElement("a");
      link.download = getSafeFilename("jpg");
      link.href = canvas.toDataURL("image/jpeg", 0.9);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      console.error("Error creating JPG:", error);
      alert("Failed to create JPG image. Check console for details.");
    }
  };
  
  img.onerror = function() {
    clearTimeout(timeoutId);
    console.error("Failed to load SVG image");
    alert("Failed to load SVG for conversion. The visualization may contain unsupported elements.");
  };
  
  // Add timeout to prevent hanging
  timeoutId = setTimeout(() => {
    console.error("Image loading timeout");
    alert("Image loading timed out.");
  }, 5000);
  
  img.src = dataUrl;
}
window.saveJpg = saveJpg;


// Debug
(function setupDebug() {
  const vbVals = (svg.attr('viewBox') || '0 0 640.67 589.39').trim().split(/[\s,]+/).map(parseFloat);
  const vb = { x: vbVals[0] || 0, y: vbVals[1] || 0, w: vbVals[2] || 640.67, h: vbVals[3] || 589.39 };

  const debugLayer = svg.append('g').attr('id', 'debug-layer').attr('pointer-events', 'none').style('display', 'none');
  const grid = debugLayer.append('g').attr('id', 'debug-grid');
  const minor = 20, major = 100;
  const majorEvery = Math.max(1, Math.round(major / minor));
  for (let i = 0; i <= Math.ceil(vb.w / minor); i++) {
    const x = vb.x + i * minor;
    const isMajor = (i % majorEvery) === 0;
    grid.append('line').attr('x1', x).attr('y1', vb.y).attr('x2', x).attr('y2', vb.y + vb.h).attr('stroke', isMajor ? '#666' : '#999').attr('stroke-width', isMajor ? 0.5 : 0.25).attr('opacity', isMajor ? 0.35 : 0.18);
  }
  for (let j = 0; j <= Math.ceil(vb.h / minor); j++) {
    const y = vb.y + j * minor;
    const isMajor = (j % majorEvery) === 0;
    grid.append('line').attr('x1', vb.x).attr('y1', y).attr('x2', vb.x + vb.w).attr('y2', y).attr('stroke', isMajor ? '#666' : '#999').attr('stroke-width', isMajor ? 0.5 : 0.25).attr('opacity', isMajor ? 0.35 : 0.18);
  }

  const cross = debugLayer.append('g').attr('id', 'debug-crosshair');
  const chV = cross.append('line').attr('stroke', '#0077ff').attr('stroke-width', 0.7).attr('opacity', 0.6);
  const chH = cross.append('line').attr('stroke', '#0077ff').attr('stroke-width', 0.7).attr('opacity', 0.6);
  const coordText = debugLayer.append('text').attr('id', 'debug-coords').attr('x', vb.x + 8).attr('y', vb.y + 18).attr('fill', '#004a99').attr('font-size', 12).text('x: -, y: -');
  const bboxRect = debugLayer.append('rect').attr('id', 'debug-bbox').attr('fill', 'none').attr('stroke', '#00aaff').attr('stroke-width', 1.5).attr('stroke-dasharray', '4,3').style('display', 'none');

  function clientToSvg(evt) {
    const pt = svg.node().createSVGPoint();
    pt.x = evt.clientX; pt.y = evt.clientY;
    const ctm = svg.node().getScreenCTM();
    if (!ctm) return { x: 0, y: 0 };
    
    // Use inverse if available, otherwise calculate it manually
    let inv;
    if (typeof ctm.inverse === 'function') {
      inv = ctm.inverse();
    } else {
      // Fallback: create inverse transformation manually
      const a = ctm.a, b = ctm.b, c = ctm.c, d = ctm.d, e = ctm.e, f = ctm.f;
      const det = a * d - b * c;
      if (Math.abs(det) < 1e-10) return { x: 0, y: 0 }; // Singular matrix
      const svg_m = svg.node().createSVGMatrix();
      inv = svg_m.multiply(ctm).translate(-ctm.e, -ctm.f);
      inv.a = d / det;
      inv.b = -b / det;
      inv.c = -c / det;
      inv.d = a / det;
      inv.e = (b * f - d * e) / det;
      inv.f = (c * e - a * f) / det;
    }
    
    const sp = pt.matrixTransform(inv);
    return { x: sp.x, y: sp.y };
  }

  svg.on('mousemove.debug', function(event) {
    const p = clientToSvg(event);
    chV.attr('x1', p.x).attr('y1', vb.y).attr('x2', p.x).attr('y2', vb.y + vb.h);
    chH.attr('x1', vb.x).attr('y1', p.y).attr('x2', vb.x + vb.w).attr('y2', p.y);
    coordText.text(`x: ${p.x.toFixed(2)}, y: ${p.y.toFixed(2)}`);
  });

  g.selectAll('g.enzyme').on('click.debug', function() {
    const bb = this.getBBox();
    bboxRect.attr('x', bb.x - 2).attr('y', bb.y - 2).attr('width', bb.width + 4).attr('height', bb.height + 4).style('display', null);
  });

  window._debugVisible = false;
  window.toggleDebug = function() {
    window._debugVisible = !window._debugVisible;
    debugLayer.style('display', window._debugVisible ? null : 'none');
  }
})();
</script>
</body>
</html>